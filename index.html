<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Local LLM Literature Reviewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
        .loading-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Markdown styles */
        .prose h1 { font-size: 1.5em; font-weight: bold; margin: 0.5em 0; }
        .prose h2 { font-size: 1.3em; font-weight: bold; margin: 0.5em 0; }
        .prose h3 { font-size: 1.1em; font-weight: bold; margin: 0.5em 0; }
        .prose p { margin: 0.5em 0; }
        .prose ul, .prose ol { margin: 0.5em 0; padding-left: 1.5em; }
        .prose li { margin: 0.25em 0; }
        .prose code { background: #374151; padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; }
        .prose pre { background: #1e293b; padding: 1em; border-radius: 8px; overflow-x: auto; margin: 0.5em 0; }
        .prose blockquote { border-left: 3px solid #3b82f6; padding-left: 1em; margin: 0.5em 0; opacity: 0.9; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="text-3xl">üìö</div>
                <div>
                    <h1 class="text-xl font-bold text-white">Local LLM Literature Reviewer</h1>
                    <p class="text-sm text-slate-400">100% Private ‚Ä¢ Browser-Based ‚Ä¢ No Cloud</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="webgpu-status" class="flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                    <span class="text-slate-400">Checking WebGPU...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel: Documents & Memory -->
            <div class="lg:col-span-1 space-y-6">
                <!-- PDF Upload Zone -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
                    <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-file-pdf text-red-400"></i>
                        Document Ingestion
                    </h2>
                    <div id="drop-zone" 
                         class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-slate-700/50 transition-all">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-500 mb-3"></i>
                        <p class="text-slate-400">Drag & drop PDF files here</p>
                        <p class="text-sm text-slate-500 mt-1">or click to browse</p>
                        <input type="file" id="file-input" multiple accept=".pdf" class="hidden">
                    </div>
                    
                    <!-- Processing Status -->
                    <div id="processing-status" class="hidden mt-4">
                        <div class="flex items-center gap-2 text-sm text-blue-400">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span id="processing-text">Processing...</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2 mt-2">
                            <div id="processing-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Memory Bank -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
                    <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-database text-purple-400"></i>
                        Memory Bank
                    </h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                            <div id="doc-count" class="text-2xl font-bold text-blue-400">0</div>
                            <div class="text-xs text-slate-400">Documents</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                            <div id="chunk-count" class="text-2xl font-bold text-green-400">0</div>
                            <div class="text-xs text-slate-400">Chunks</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                            <div id="vector-count" class="text-2xl font-bold text-purple-400">0</div>
                            <div class="text-xs text-slate-400">Vectors</div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-3 text-center">
                            <div id="storage-size" class="text-2xl font-bold text-orange-400">0</div>
                            <div class="text-xs text-slate-400">KB Used</div>
                        </div>
                    </div>
                    
                    <!-- Document List -->
                    <div id="document-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-sm text-slate-500 italic">No documents loaded yet</p>
                    </div>
                    
                    <button id="clear-memory" class="w-full mt-4 py-2 px-4 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition-colors text-sm">
                        <i class="fas fa-trash mr-2"></i>Clear All Memory
                    </button>
                </div>

                <!-- System Controls -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
                    <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-sliders-h text-cyan-400"></i>
                        System Controls
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Temperature -->
                        <div>
                            <label class="flex items-center justify-between text-sm text-slate-400 mb-1">
                                <span>Temperature</span>
                                <span id="temp-value" class="text-cyan-400">0.7</span>
                            </label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7"
                                   class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        
                        <!-- Top K Chunks -->
                        <div>
                            <label class="flex items-center justify-between text-sm text-slate-400 mb-1">
                                <span>Top K Chunks</span>
                                <span id="topk-value" class="text-cyan-400">5</span>
                            </label>
                            <input type="range" id="top-k" min="1" max="10" step="1" value="5"
                                   class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        
                        <!-- System Prompt -->
                        <div>
                            <label class="text-sm text-slate-400 mb-1 block">System Prompt</label>
                            <textarea id="system-prompt" rows="4"
                                      class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-sm text-slate-200 resize-none focus:outline-none focus:border-blue-500">You are an expert Academic Researcher and Literature Review specialist. Your role is to:
1. Analyze and synthesize information from research papers
2. Identify key themes, methodologies, and findings
3. Compare and contrast different papers' perspectives
4. Generate structured, professional literature reviews
5. Always cite the specific papers you reference

Be precise, academic, and thorough in your analysis.</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Chat Interface -->
            <div class="lg:col-span-2 flex flex-col bg-slate-800 rounded-xl border border-slate-700 overflow-hidden" style="height: calc(100vh - 180px);">
                <!-- Model Loading Status -->
                <div id="model-status" class="bg-slate-700/50 px-4 py-3 border-b border-slate-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="model-indicator" class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <span id="model-text" class="text-sm text-slate-300">Loading models...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="load-models-btn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-rocket mr-1"></i>Load Models
                            </button>
                        </div>
                    </div>
                    <div id="model-progress" class="hidden mt-2">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span id="model-progress-text">Initializing...</span>
                            <span id="model-progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-1.5">
                            <div id="model-progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Welcome Message -->
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg rounded-tl-none p-4 max-w-2xl">
                            <p class="text-slate-200">Welcome to the <strong>Local LLM Literature Reviewer</strong>! üìö</p>
                            <p class="text-slate-300 mt-2">I run entirely in your browser - no data leaves your device. Here's how to get started:</p>
                            <ol class="text-slate-300 mt-2 ml-4 list-decimal space-y-1">
                                <li>Click <strong>"Load Models"</strong> to initialize the AI (requires WebGPU)</li>
                                <li>Upload your research PDFs using the drop zone</li>
                                <li>Ask me questions or request a literature review!</li>
                            </ol>
                            <p class="text-slate-400 text-sm mt-3 italic">Tip: Try "Generate a literature review of the uploaded papers"</p>
                        </div>
                    </div>
                </div>

                <!-- Context Panel (shows retrieved chunks) -->
                <div id="context-panel" class="hidden border-t border-slate-700 bg-slate-800/50 max-h-48 overflow-y-auto">
                    <div class="p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-slate-400">
                                <i class="fas fa-quote-left mr-1"></i>Retrieved Context
                            </span>
                            <button id="close-context" class="text-slate-500 hover:text-slate-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="context-chunks" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t border-slate-700 p-4">
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <textarea id="user-input" 
                                      placeholder="Ask about your papers or request a literature review..."
                                      rows="2"
                                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 pr-12 text-slate-200 resize-none focus:outline-none focus:border-blue-500 placeholder-slate-500"
                                      disabled></textarea>
                            <button id="voice-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-blue-400 transition-colors" title="Voice Input">
                                <i class="fas fa-microphone text-lg"></i>
                            </button>
                        </div>
                        <button id="send-btn" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs text-slate-500">
                        <span>Press Enter to send, Shift+Enter for new line</span>
                        <span id="char-count">0 / 2000</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio Feedback -->
    <div id="voice-indicator" class="hidden fixed bottom-24 right-8 bg-red-600 text-white px-4 py-2 rounded-full flex items-center gap-2 shadow-lg">
        <i class="fas fa-microphone"></i>
        <span>Listening...</span>
        <div class="flex gap-1">
            <div class="w-1 h-4 bg-white rounded animate-pulse"></div>
            <div class="w-1 h-6 bg-white rounded animate-pulse" style="animation-delay: 0.1s"></div>
            <div class="w-1 h-3 bg-white rounded animate-pulse" style="animation-delay: 0.2s"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // ============================================
        // CONFIGURATION & STATE
        // ============================================
        const CONFIG = {
            CHUNK_SIZE: 500,
            CHUNK_OVERLAP: 100,
            EMBEDDING_MODEL: 'Xenova/all-MiniLM-L6-v2',
            LLM_MODEL: 'Llama-3.2-1B-Instruct-q4f16_1-MLC',
            TOP_K: 5,
            TEMPERATURE: 0.7
        };

        const state = {
            vectorStore: [],
            documents: [],
            chatHistory: [],
            embeddingPipeline: null,
            llmEngine: null,
            isProcessing: false,
            isGenerating: false,
            modelsLoaded: false
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Cosine Similarity - Pure JS implementation
        function cosineSimilarity(vecA, vecB) {
            if (vecA.length !== vecB.length) return 0;
            
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            
            const magnitude = Math.sqrt(normA) * Math.sqrt(normB);
            return magnitude === 0 ? 0 : dotProduct / magnitude;
        }

        // Text chunking with sliding window
        function chunkText(text, chunkSize = CONFIG.CHUNK_SIZE, overlap = CONFIG.CHUNK_OVERLAP) {
            const chunks = [];
            const cleanText = text.replace(/\s+/g, ' ').trim();
            
            if (cleanText.length <= chunkSize) {
                return [cleanText];
            }
            
            let start = 0;
            while (start < cleanText.length) {
                const end = Math.min(start + chunkSize, cleanText.length);
                const chunk = cleanText.slice(start, end);
                
                if (chunk.trim().length > 50) { // Minimum meaningful chunk
                    chunks.push(chunk.trim());
                }
                
                start += chunkSize - overlap;
            }
            
            return chunks;
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0';
            const k = 1024;
            return Math.round(bytes / k);
        }

        // Simple markdown to HTML
        function markdownToHtml(text) {
            return text
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        // ============================================
        // PDF EXTRACTION
        // ============================================
        async function extractTextFromPDF(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n';
                        
                        // Update progress
                        const progress = Math.round((i / pdf.numPages) * 50);
                        updateProcessingProgress(progress, `Extracting page ${i}/${pdf.numPages}...`);
                    }
                    
                    resolve(fullText.trim());
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ============================================
        // EMBEDDING & VECTOR STORE
        // ============================================
        async function generateEmbedding(text) {
            if (!state.embeddingPipeline) {
                throw new Error('Embedding model not loaded');
            }
            
            const result = await state.embeddingPipeline(text, {
                pooling: 'mean',
                normalize: true
            });
            
            return Array.from(result.data);
        }

        async function addToVectorStore(chunks, source) {
            const totalChunks = chunks.length;
            
            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                const embedding = await generateEmbedding(chunk);
                
                state.vectorStore.push({
                    text: chunk,
                    embedding: embedding,
                    source: source,
                    id: `${source}-${i}`
                });
                
                // Update progress
                const progress = 50 + Math.round((i / totalChunks) * 50);
                updateProcessingProgress(progress, `Embedding chunk ${i + 1}/${totalChunks}...`);
            }
            
            updateMemoryDisplay();
        }

        function searchVectorStore(queryEmbedding, topK = CONFIG.TOP_K) {
            if (state.vectorStore.length === 0) return [];
            
            const similarities = state.vectorStore.map(item => ({
                ...item,
                similarity: cosineSimilarity(queryEmbedding, item.embedding)
            }));
            
            similarities.sort((a, b) => b.similarity - a.similarity);
            return similarities.slice(0, topK);
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateMemoryDisplay() {
            const uniqueDocs = new Set(state.vectorStore.map(v => v.source));
            document.getElementById('doc-count').textContent = uniqueDocs.size;
            document.getElementById('chunk-count').textContent = state.vectorStore.length;
            document.getElementById('vector-count').textContent = state.vectorStore.length;
            
            // Estimate storage size
            const size = JSON.stringify(state.vectorStore).length;
            document.getElementById('storage-size').textContent = formatBytes(size);
            
            // Update document list
            const docList = document.getElementById('document-list');
            if (uniqueDocs.size === 0) {
                docList.innerHTML = '<p class="text-sm text-slate-500 italic">No documents loaded yet</p>';
            } else {
                docList.innerHTML = Array.from(uniqueDocs).map(doc => {
                    const chunkCount = state.vectorStore.filter(v => v.source === doc).length;
                    return `
                        <div class="flex items-center justify-between bg-slate-700/50 rounded-lg px-3 py-2">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas fa-file-pdf text-red-400 flex-shrink-0"></i>
                                <span class="text-sm text-slate-300 truncate">${doc}</span>
                            </div>
                            <span class="text-xs text-slate-500 flex-shrink-0">${chunkCount} chunks</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateProcessingProgress(percent, text) {
            document.getElementById('processing-bar').style.width = `${percent}%`;
            document.getElementById('processing-text').textContent = text;
        }

        function showProcessing(show) {
            document.getElementById('processing-status').classList.toggle('hidden', !show);
        }

        function addMessage(role, content, sources = []) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3';
            
            const isUser = role === 'user';
            const avatar = isUser 
                ? '<div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center flex-shrink-0"><i class="fas fa-user text-white text-sm"></i></div>'
                : '<div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-sm"></i></div>';
            
            const bgColor = isUser ? 'bg-blue-600/20' : 'bg-slate-700/50';
            const roundedClass = isUser ? 'rounded-tr-none' : 'rounded-tl-none';
            
            let sourcesHtml = '';
            if (sources.length > 0 && !isUser) {
                const uniqueSources = [...new Set(sources.map(s => s.source))];
                sourcesHtml = `
                    <div class="mt-3 pt-3 border-t border-slate-600">
                        <div class="text-xs text-slate-400 mb-2">
                            <i class="fas fa-quote-left mr-1"></i>Sources used:
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${uniqueSources.map(s => `
                                <span class="px-2 py-1 bg-slate-600/50 rounded text-xs text-slate-300">
                                    <i class="fas fa-file-pdf text-red-400 mr-1"></i>${s}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="${bgColor} rounded-lg ${roundedClass} p-4 max-w-2xl prose text-slate-200">
                    ${isUser ? content : markdownToHtml(content)}
                    ${sourcesHtml}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex gap-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-slate-700/50 rounded-lg rounded-tl-none p-4">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function showContextPanel(chunks) {
            const panel = document.getElementById('context-panel');
            const container = document.getElementById('context-chunks');
            
            container.innerHTML = chunks.map((chunk, i) => `
                <div class="bg-slate-700/50 rounded p-2 text-xs">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-blue-400 font-medium">${chunk.source}</span>
                        <span class="text-slate-500">${(chunk.similarity * 100).toFixed(1)}% match</span>
                    </div>
                    <p class="text-slate-400 line-clamp-2">${chunk.text.substring(0, 150)}...</p>
                </div>
            `).join('');
            
            panel.classList.remove('hidden');
        }

        // ============================================
        // MODEL LOADING
        // ============================================
        async function checkWebGPU() {
            const statusEl = document.getElementById('webgpu-status');
            
            if (!navigator.gpu) {
                statusEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span class="text-red-400">WebGPU not supported</span>
                `;
                return false;
            }
            
            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    statusEl.innerHTML = `
                        <span class="w-2 h-2 rounded-full bg-red-500"></span>
                        <span class="text-red-400">No GPU adapter found</span>
                    `;
                    return false;
                }
                
                statusEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span class="text-green-400">WebGPU Ready</span>
                `;
                return true;
            } catch (e) {
                statusEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span class="text-red-400">WebGPU error</span>
                `;
                return false;
            }
        }

        async function loadModels() {
            const modelStatus = document.getElementById('model-status');
            const modelIndicator = document.getElementById('model-indicator');
            const modelText = document.getElementById('model-text');
            const modelProgress = document.getElementById('model-progress');
            const progressBar = document.getElementById('model-progress-bar');
            const progressText = document.getElementById('model-progress-text');
            const progressPercent = document.getElementById('model-progress-percent');
            const loadBtn = document.getElementById('load-models-btn');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
            modelProgress.classList.remove('hidden');
            
            try {
                // Load Transformers.js for embeddings
                progressText.textContent = 'Loading Transformers.js...';
                progressPercent.textContent = '10%';
                progressBar.style.width = '10%';
                
                const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');
                
                progressText.textContent = 'Loading embedding model...';
                progressPercent.textContent = '30%';
                progressBar.style.width = '30%';
                
                state.embeddingPipeline = await pipeline('feature-extraction', CONFIG.EMBEDDING_MODEL, {
                    progress_callback: (progress) => {
                        if (progress.status === 'progress') {
                            const pct = Math.round(30 + (progress.progress * 0.2));
                            progressPercent.textContent = `${pct}%`;
                            progressBar.style.width = `${pct}%`;
                        }
                    }
                });
                
                // Load WebLLM
                progressText.textContent = 'Loading WebLLM...';
                progressPercent.textContent = '50%';
                progressBar.style.width = '50%';
                
                const webllm = await import('https://esm.run/@mlc-ai/web-llm');
                
                progressText.textContent = 'Loading LLM model (this may take a while)...';
                
                state.llmEngine = await webllm.CreateMLCEngine(CONFIG.LLM_MODEL, {
                    initProgressCallback: (progress) => {
                        const pct = Math.round(50 + (progress.progress * 50));
                        progressPercent.textContent = `${pct}%`;
                        progressBar.style.width = `${pct}%`;
                        progressText.textContent = progress.text || 'Loading LLM...';
                    }
                });
                
                // Success!
                state.modelsLoaded = true;
                modelIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                modelText.textContent = 'Models ready!';
                modelText.className = 'text-sm text-green-400';
                modelProgress.classList.add('hidden');
                loadBtn.classList.add('hidden');
                
                // Enable chat
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                
                addMessage('assistant', 'Models loaded successfully! üéâ I\'m ready to help you analyze your research papers. Upload some PDFs and ask me anything!');
                
            } catch (error) {
                console.error('Error loading models:', error);
                modelIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                modelText.textContent = 'Error loading models';
                modelText.className = 'text-sm text-red-400';
                progressText.textContent = error.message;
                loadBtn.disabled = false;
                loadBtn.innerHTML = '<i class="fas fa-redo mr-1"></i>Retry';
                
                addMessage('assistant', `‚ùå Error loading models: ${error.message}\n\nPlease make sure you're using a browser with WebGPU support (Chrome 113+ or Edge 113+).`);
            }
        }

        // ============================================
        // CHAT LOGIC
        // ============================================
        async function handleChat(userMessage) {
            if (!state.modelsLoaded || state.isGenerating) return;
            
            state.isGenerating = true;
            const sendBtn = document.getElementById('send-btn');
            const userInput = document.getElementById('user-input');
            sendBtn.disabled = true;
            userInput.disabled = true;
            
            // Add user message
            addMessage('user', userMessage);
            state.chatHistory.push({ role: 'user', content: userMessage });
            
            showTypingIndicator();
            
            try {
                // Get relevant context from vector store
                let relevantChunks = [];
                let contextText = '';
                
                if (state.vectorStore.length > 0) {
                    const queryEmbedding = await generateEmbedding(userMessage);
                    const topK = parseInt(document.getElementById('top-k').value);
                    relevantChunks = searchVectorStore(queryEmbedding, topK);
                    
                    if (relevantChunks.length > 0) {
                        showContextPanel(relevantChunks);
                        contextText = relevantChunks.map((chunk, i) => 
                            `[Source: ${chunk.source}]\n${chunk.text}`
                        ).join('\n\n---\n\n');
                    }
                }
                
                // Build prompt
                const systemPrompt = document.getElementById('system-prompt').value;
                const temperature = parseFloat(document.getElementById('temperature').value);
                
                // Combine system prompt with context (WebLLM only allows ONE system message at the start)
                let fullSystemPrompt = systemPrompt;
                if (contextText) {
                    fullSystemPrompt += `\n\n---\n\nHere are relevant excerpts from the uploaded research papers:\n\n${contextText}\n\nUse this context to answer the user's question. Always cite which paper/source you're referencing.`;
                }
                
                let messages = [
                    { role: 'system', content: fullSystemPrompt }
                ];
                
                // Add chat history (last 6 messages for context window management)
                const recentHistory = state.chatHistory.slice(-6);
                messages = messages.concat(recentHistory);
                
                // Generate response
                const response = await state.llmEngine.chat.completions.create({
                    messages: messages,
                    temperature: temperature,
                    max_tokens: 1024,
                    stream: true
                });
                
                hideTypingIndicator();
                
                // Stream the response
                let fullResponse = '';
                const chatMessages = document.getElementById('chat-messages');
                
                // Create message container with unique ID
                const messageId = 'msg-' + Date.now();
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex gap-3';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg rounded-tl-none p-4 max-w-2xl prose text-slate-200">
                        <span id="${messageId}"></span>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                
                const streamingContent = document.getElementById(messageId);
                
                for await (const chunk of response) {
                    const delta = chunk.choices[0]?.delta?.content || '';
                    fullResponse += delta;
                    streamingContent.innerHTML = markdownToHtml(fullResponse);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Add sources to the message
                if (relevantChunks.length > 0) {
                    const uniqueSources = [...new Set(relevantChunks.map(s => s.source))];
                    const sourcesHtml = `
                        <div class="mt-3 pt-3 border-t border-slate-600">
                            <div class="text-xs text-slate-400 mb-2">
                                <i class="fas fa-quote-left mr-1"></i>Sources used:
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${uniqueSources.map(s => `
                                    <span class="px-2 py-1 bg-slate-600/50 rounded text-xs text-slate-300">
                                        <i class="fas fa-file-pdf text-red-400 mr-1"></i>${s}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    messageDiv.querySelector('.prose').innerHTML += sourcesHtml;
                }
                
                streamingContent.removeAttribute('id');
                
                // Add to history
                state.chatHistory.push({ role: 'assistant', content: fullResponse });
                
                // TTS if enabled (using browser's SpeechSynthesis)
                if (window.speechSynthesis && fullResponse.length < 500) {
                    // Only for shorter responses
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addMessage('assistant', `‚ùå Error generating response: ${error.message}`);
            }
            
            state.isGenerating = false;
            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Check WebGPU
            await checkWebGPU();
            
            // File upload
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-slate-700/50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-slate-700/50');
            });
            
            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-slate-700/50');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
                await processFiles(files);
            });
            
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                await processFiles(files);
                e.target.value = '';
            });
            
            async function processFiles(files) {
                if (files.length === 0) return;
                if (!state.embeddingPipeline) {
                    addMessage('assistant', '‚ö†Ô∏è Please load the models first before uploading documents.');
                    return;
                }
                if (state.isProcessing) return;
                
                state.isProcessing = true;
                showProcessing(true);
                
                for (const file of files) {
                    try {
                        updateProcessingProgress(0, `Processing ${file.name}...`);
                        
                        // Extract text
                        const text = await extractTextFromPDF(file);
                        
                        if (text.trim().length < 100) {
                            addMessage('assistant', `‚ö†Ô∏è Could not extract meaningful text from ${file.name}. The PDF might be image-based.`);
                            continue;
                        }
                        
                        // Chunk text
                        const chunks = chunkText(text);
                        
                        // Add to vector store
                        await addToVectorStore(chunks, file.name);
                        
                        state.documents.push({
                            name: file.name,
                            chunkCount: chunks.length,
                            textLength: text.length
                        });
                        
                        addMessage('assistant', `‚úÖ Successfully processed **${file.name}**\n- Extracted ${text.length.toLocaleString()} characters\n- Created ${chunks.length} chunks\n- Generated ${chunks.length} embeddings`);
                        
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                        addMessage('assistant', `‚ùå Error processing ${file.name}: ${error.message}`);
                    }
                }
                
                showProcessing(false);
                state.isProcessing = false;
            }
            
            // Load models button
            document.getElementById('load-models-btn').addEventListener('click', loadModels);
            
            // Clear memory
            document.getElementById('clear-memory').addEventListener('click', () => {
                state.vectorStore = [];
                state.documents = [];
                updateMemoryDisplay();
                addMessage('assistant', 'üóëÔ∏è Memory cleared. All documents have been removed.');
            });
            
            // Temperature slider
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('temp-value').textContent = e.target.value;
                CONFIG.TEMPERATURE = parseFloat(e.target.value);
            });
            
            // Top K slider
            document.getElementById('top-k').addEventListener('input', (e) => {
                document.getElementById('topk-value').textContent = e.target.value;
                CONFIG.TOP_K = parseInt(e.target.value);
            });
            
            // Chat input
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            
            userInput.addEventListener('input', () => {
                document.getElementById('char-count').textContent = `${userInput.value.length} / 2000`;
            });
            
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (userInput.value.trim() && !sendBtn.disabled) {
                        handleChat(userInput.value.trim());
                        userInput.value = '';
                        document.getElementById('char-count').textContent = '0 / 2000';
                    }
                }
            });
            
            sendBtn.addEventListener('click', () => {
                if (userInput.value.trim()) {
                    handleChat(userInput.value.trim());
                    userInput.value = '';
                    document.getElementById('char-count').textContent = '0 / 2000';
                }
            });
            
            // Close context panel
            document.getElementById('close-context').addEventListener('click', () => {
                document.getElementById('context-panel').classList.add('hidden');
            });
            
            // Voice input (bonus feature)
            const voiceBtn = document.getElementById('voice-btn');
            const voiceIndicator = document.getElementById('voice-indicator');
            let mediaRecorder = null;
            let audioChunks = [];
            
            voiceBtn.addEventListener('click', async () => {
                if (!state.modelsLoaded) {
                    addMessage('assistant', '‚ö†Ô∏è Please load the models first.');
                    return;
                }
                
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    voiceIndicator.classList.add('hidden');
                    voiceBtn.classList.remove('text-red-500');
                    return;
                }
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                    
                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        
                        // For now, use Web Speech API for STT (Whisper would require more setup)
                        addMessage('assistant', 'üé§ Voice input recorded. (Note: Full Whisper STT requires additional setup. Using browser speech recognition as fallback.)');
                    };
                    
                    mediaRecorder.start();
                    voiceIndicator.classList.remove('hidden');
                    voiceBtn.classList.add('text-red-500');
                    
                    // Auto-stop after 10 seconds
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            voiceIndicator.classList.add('hidden');
                            voiceBtn.classList.remove('text-red-500');
                        }
                    }, 10000);
                    
                } catch (error) {
                    console.error('Microphone error:', error);
                    addMessage('assistant', '‚ùå Could not access microphone. Please check permissions.');
                }
            });
        });
    </script>
</body>
</html>